---
title: "SMPE Project"
author: "Insaf Boukrouh & Othmane Nahyl"
date: "30 d√©cembre 2017"
output: html_document
---

## Cleaning the datasets
```{r}
library(plyr)
library(doParallel)

# Register parallel backend in order to load files in parallel
nodes <- detectCores()
cl <- makeCluster(nodes)
registerDoParallel(cl)

cities_data = ldply(list.files(path = "../test-dataset/", pattern = "csv", full.names=TRUE), .parallel = TRUE, function(filename) {
  # Columns to keep
    keeps <- c("id","host_id","host_response_time","host_response_rate","host_acceptance_rate","host_total_listings_count","zipcode","country_code","property_type","room_type","accommodates","bathrooms","bedrooms","beds","bed_type","square_feet","price","security_deposit","cleaning_fee","extra_people","minimum_nights","maximum_nights","number_of_reviews","review_scores_rating","review_scores_accuracy","review_scores_cleanliness","review_scores_checkin","review_scores_communication","review_scores_location","review_scores_value","instant_bookable","cancellation_policy","host_since","calendar_last_scraped")
    city_data = read.csv(filename)
    city_data <- city_data[keeps]
    
    return(city_data)
})

# Convert host_response_rate from factors to numeric values
cities_data$host_response_rate = as.numeric(gsub("%", "", as.character(cities_data$host_response_rate)))/100

# Convert price from factors to numeric values
cities_data$price <- as.double(substring(gsub(",", "", as.character(cities_data$price)),2))

# Convert security_deposit from factors to numeric values
cities_data$security_deposit <- as.double(substring(gsub(",", "", as.character(cities_data$security_deposit)),2))
cities_data$security_deposit[is.na(cities_data$security_deposit)] <- 0

# Convert cleaning_fee from factors to numeric values
cities_data$cleaning_fee <- as.double(substring(gsub(",", "", as.character(cities_data$cleaning_fee)),2))
cities_data$cleaning_fee[is.na(cities_data$cleaning_fee)] <- 0

# Convert extra_people from factors to numeric values
cities_data$extra_people <- as.double(substring(gsub(",", "", as.character(cities_data$extra_people)),2))
cities_data$extra_people[is.na(cities_data$extra_people)] <- 0

stopCluster(cl)
```

## Incomes

```{r}
library(ggplot2)

# Remove lines with NA values in the columns that we're interested in
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
cities_data <- completeFun(cities_data, c("price", "minimum_nights", "number_of_reviews", "host_since", "calendar_last_scraped"))

# Calculate the income for each host per month
cities_data$income <- cities_data$number_of_reviews*cities_data$minimum_nights*cities_data$price
cities_data$duration <- abs(as.Date(as.character(cities_data$calendar_last_scraped), format = "%Y-%m-%d") -
                        as.Date(as.character(cities_data$host_since), format = "%Y-%m-%d"))/30

# TODO Show histograms only for some countries
for (country in unique(cities_data$country_code)) {
  country_data <- subset(cities_data, cities_data$country_code == country)
  country_data <- setNames(
    aggregate(
    cbind(country_data$income, country_data$duration),
    by = list(host_id = country_data$host_id),
    FUN = function(x) sum(x))
    , c("Host Identifier", "Income", "Duration"))
  country_data$income_per_month = unlist(country_data['Income'])/unlist(country_data['Duration'])
  print(ggplot(country_data, aes(x = income_per_month))
        + geom_histogram(color = "darkblue", fill = "lightblue")
        + labs(title = country, x = "Income per month", y = "Count"))
}
```

## Miscellaneous
### Type of listings
```{r}
roomTypes <- table(cities_data$room_type)
names <- names(roomTypes)
values <- as.vector(roomTypes)
percentages <- scales::percent(round(values/sum(values), 2))
names_percentages <- sprintf("%s (%s)", names, percentages)

df <- data.frame(group = names,value = values)
pie <- ggplot(df, aes(x = "", y = value, fill = names_percentages))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start = 0)+
  scale_fill_brewer("Room Types", palette = "Dark2")+
  ggtitle("Type of listings")+
  ylab("")+
  xlab("")+
  labs(fill="")+
  theme(axis.ticks = element_blank(), panel.grid = element_blank(), axis.text = element_blank())+
  geom_text(aes(label = percentages), size = 5, position = position_stack(vjust = 0.5))
pie
```

### Evolution of new hosts over time
```{r}
cities_data <- completeFun(cities_data, c("host_since"))
cities_data$host_since <- as.Date(cities_data$host_since, '%Y-%m-%d')
cities_data <- cities_data[order(as.Date(cities_data$host_since, format="%Y-%m-%d")),]
cities_data$host_since <- format(as.Date(cities_data$host_since, "%Y-%m-%d"), format="%Y")
mydata <- table(cities_data$host_since)
plot(names(mydata), as.vector(mydata), type = "l", xlab = "Time", ylab = "Number of new hosts")
```






